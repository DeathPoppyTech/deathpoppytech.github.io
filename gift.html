<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gift User</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="content" class="container">Loading...</div>

  <script>
  async function main() {
    const params = new URLSearchParams(window.location.search);
    const username = params.get("user");
    const content = document.getElementById("content");
    const corsProxy = "https://api.allorigins.win/raw?url=";

    if (!username) {
      content.innerHTML = "<p>‚ùå No username provided. <a href='index.html'>Go back</a></p>";
      return;
    }

    content.innerHTML = `<p>üîç Searching for <b>${username}</b>...</p>`;

    try {
      // Fetch user info
      const userRes = await fetch(corsProxy + encodeURIComponent("https://users.roblox.com/v1/usernames/users"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usernames: [username] })
      });
      const userData = await userRes.json();
      const user = userData.data?.[0];
      if (!user) {
        content.innerHTML = "<p>‚ùå User not found. <a href='index.html'>Try again</a></p>";
        return;
      }

      const userId = user.id;
      const displayName = user.displayName || user.name;
      const avatar = `https://www.roblox.com/headshot-thumbnail/image?userId=${userId}&width=180&height=180&format=png`;

      // Fetch clothing using the newer Creator Marketplace endpoint
      const clothingRes = await fetch(corsProxy + encodeURIComponent(`https://catalog.roblox.com/v1/search/items/details?CreatorTargetId=${userId}&Limit=30&Category=3`));
      const clothing = await clothingRes.json();

      // Fetch gamepasses (directly from inventory API)
      const passesRes = await fetch(corsProxy + encodeURIComponent(`https://inventory.roblox.com/v1/users/${userId}/assets/34?limit=30`));
      const passes = await passesRes.json();

      async function getItemPrice(assetId) {
        try {
          const res = await fetch(corsProxy + encodeURIComponent(`https://economy.roblox.com/v2/assets/${assetId}/details`));
          const data = await res.json();
          return data.PriceInRobux ?? null;
        } catch {
          return null;
        }
      }

      let html = `
        <div class="profile">
          <img src="${avatar}" width="120" height="120" alt="Avatar">
          <h1>${displayName} (@${user.name})</h1>
          <p>User ID: ${userId}</p>
          <a href="index.html" class="back">‚Üê Search another user</a>
        </div>
      `;

      // Gamepasses section
      html += "<h2>üéüÔ∏è Gamepasses</h2>";
      if (passes.data && passes.data.length > 0) {
        html += `<div class="items">`;
        for (const p of passes.data) {
          const price = await getItemPrice(p.assetId);
          html += `
            <div class="item">
              <img src="https://www.roblox.com/asset-thumbnail/image?assetId=${p.assetId}&width=150&height=150&format=png" alt="${p.name}">
              <p>${p.name}</p>
              <p class="price">${price ? `${price} Robux` : "Free"}</p>
              <a href="https://www.roblox.com/game-pass/${p.assetId}" target="_blank"><button>Buy</button></a>
            </div>
          `;
        }
        html += `</div>`;
      } else {
        html += "<p>No gamepasses found.</p>";
      }

      // Clothing section
      html += "<h2>üëï Clothing</h2>";
      if (clothing.data && clothing.data.length) {
        html += `<div class="items">`;
        for (const item of clothing.data) {
          const price = await getItemPrice(item.id);
          html += `
            <div class="item">
              <img src="https://www.roblox.com/asset-thumbnail/image?assetId=${item.id}&width=150&height=150&format=png" alt="${item.name}">
              <p>${item.name}</p>
              <p class="price">${price ? `${price} Robux` : "Free"}</p>
              <a href="https://www.roblox.com/catalog/${item.id}" target="_blank">
                <button>Buy</button>
              </a>
            </div>
          `;
        }
        html += `</div>`;
      } else {
        html += "<p>No clothing found.</p>";
      }

      content.innerHTML = html;

    } catch (err) {
      console.error(err);
      content.innerHTML = `<p>‚ö†Ô∏è Failed to fetch data. Please try again later.</p>`;
    }
  }

  main();
  </script>
</body>
</html>
